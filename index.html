<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My LEGO Sets and Content Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark text for contrast */
        }
        /* Custom styles for better card layout */
        .card {
            @apply bg-white p-4 rounded-lg shadow-sm cursor-pointer transition-transform duration-200 hover:scale-105;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .thumbnail.active {
            border: 2px solid #f97316; /* Highlight active thumbnail */
            box-shadow: 0 0 5px rgba(249, 115, 22, 0.5);
        }

        /* New custom styles for the image gallery with navigation */
        .main-image-container {
            position: relative;
            width: 100%;
            padding-bottom: 75%; /* Maintain a 4:3 aspect ratio */
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .main-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Use contain to show full image without cropping */
        }
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.5rem;
            user-select: none;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .nav-arrow:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .nav-arrow.left {
            left: 0.5rem;
            border-top-left-radius: 0.25rem;
            border-bottom-left-radius: 0.25rem;
        }
        .nav-arrow.right {
            right: 0.5rem;
            border-top-right-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }

        /* Custom scrollbar for the video list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
    </style>

    <!-- FAVICON LINK using the logo.png file -->
    <link rel="icon" href="images/logo.png" type="image/png">

</head>
<body class="p-4 md:p-8 flex flex-col min-h-screen">
    <!-- Main content container -->
    <div class="grid grid-cols-1 w-full max-w-7xl mx-auto">
        <!-- Main Application Column -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
            
            <!-- Logo and Language Selector Section -->
            <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
                <!-- Logo and Store Name, now clickable to return to the main catalog -->
                <div id="logo-container" class="cursor-pointer flex items-center justify-center sm:justify-start mb-4 sm:mb-0" onclick="showCatalog()">
                    <img src="./images/logo.png" 
                        onerror="this.onerror=null;this.src='https://placehold.co/200x80/637082/ffffff?text=Your+Logo'" 
                        alt="Your Brand Logo" 
                        class="h-20 w-auto">
                    <span class="ml-4 text-4xl font-bold text-gray-800">BrickFolder</span>
                </div>
                <!-- Language Selector with a dynamic flag icon and dropdown -->
                <div class="flex items-center space-x-2">
                    <!-- Dynamic flag icon based on selection, now with a fixed width for consistent length -->
                    <img id="flag-icon" src="./images/us.svg" alt="Flag" class="w-16 h-auto">
                    <!-- Language dropdown, reverted to its original size -->
                    <select id="language-select" class="p-2 rounded-md border border-gray-300 shadow-sm focus:border-yellow-500 focus:ring focus:ring-yellow-500 focus:ring-opacity-50">
                        <option value="en">English</option>
                        <option value="ua">Українська</option>
                    </select>
                </div>
            </div>
            
            <!-- BrickLink Store Splash Section -->
            <!-- ADD 'max-w-4xl mx-auto' after text-center to make this section narrower and centered -->
            <div id="store_splash" class="bg-gray-100 p-6 md:p-8 rounded-xl shadow-inner mb-6 text-center">
                <h2 data-translate="store_title" class="text-2xl font-bold text-gray-800 mb-2">Visit My BrickLink Store!</h2>
                <p data-translate="store_text" class="text-gray-600 mb-4">
                    Find new and used LEGO sets, parts, and minifigures in my store. I offer a wide selection and great prices.
                </p>
                <a href="https://store.bricklink.com/BrickFolder#/shop" target="_blank" data-translate="store_button" class="inline-block px-6 py-3 bg-yellow-500 text-white font-semibold rounded-md shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition-colors duration-200">
                    Go to the Store
                </a>
            </div>

            <!-- Sets Catalog Section -->
            <div id="catalog_view" class="block">
                <h2 data-translate="catalog_title" class="text-2xl font-bold text-center text-gray-800 mb-6">My LEGO Sets Catalog</h2>
                <p data-translate="catalog_subtitle" class="text-sm text-center text-gray-600 mb-6">
                    A showcase of my favorite LEGO sets.
                </p>
                
                <!-- Theme Selector and Search Bar -->
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
                    <div class="flex items-center w-full sm:w-auto">
                        <label for="theme-select" data-translate="theme_label" class="mr-2 font-medium shrink-0">Select a Theme:</label>
                        <select id="theme-select" class="p-2 rounded-md border border-gray-300 shadow-sm w-full focus:border-yellow-500 focus:ring focus:ring-yellow-500 focus:ring-opacity-50">
                            <option value="">Loading themes...</option>
                        </select>
                    </div>
                    <div class="flex items-center w-full sm:w-auto">
                        <label for="search_input" class="sr-only">Search</label>
                        <input type="text" id="search_input" placeholder="Search sets..." class="p-2 rounded-md border border-gray-300 shadow-sm w-full focus:border-yellow-500 focus:ring focus:ring-yellow-500 focus:ring-opacity-50">
                    </div>
                </div>

                <div id="sets_catalog" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Set cards will be dynamically populated here -->
                </div>
                <!-- Loading indicator -->
                <div id="loader" class="flex justify-center my-8 hidden">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- Individual Set Detail Section (initially hidden) -->
            <div id="set_detail_view" class="hidden">
                <button id="back_to_catalog" data-translate="back_button" class="mb-4 text-blue-600 hover:text-blue-800 font-medium">
                    &larr; Back to Catalog
                </button>
                <!-- ADDED 'max-w-5xl mx-auto' to make this section narrower and centered -->
                <div id="set_detail_content" class="space-y-4 max-w-5xl mx-auto">
                    <!-- Set details will be dynamically populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Social Media Contacts Section -->
    <div class="w-full max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg mt-8 text-center">
        <h2 data-translate="connect_title" class="text-2xl font-bold text-gray-800 mb-4">Connect With Me</h2>
        <div class="flex justify-center space-x-6">
            <a href="https://www.instagram.com/brickfolder" target="_blank" class="p-1 transition-all duration-200 border-2 border-transparent rounded-md hover:border-yellow-500" title="Instagram">
                <img src="./images/instagram.svg" class="w-8 h-8" alt="Instagram Logo">
            </a>
            <a href="https://www.youtube.com/@BrickFolder" target="_blank" class="p-1 transition-all duration-200 border-2 border-transparent rounded-md hover:border-yellow-500" title="YouTube">
                <img src="./images/youtube.svg" class="w-8 h-8" alt="YouTube Logo">
            </a>
            <a href="https://www.facebook.com/brickfolder" target="_blank" class="p-1 transition-all duration-200 border-2 border-transparent rounded-md hover:border-yellow-500" title="Facebook">
                <img src="./images/facebook.svg" class="w-8 h-8" alt="Facebook Logo">
            </a>
            <a href="https://t.me/brickfolder" target="_blank" class="p-1 transition-all duration-200 border-2 border-transparent rounded-md hover:border-yellow-500" title="Telegram">
                <img src="./images/telegram.svg" class="w-8 h-8" alt="Telegram Logo">
            </a>
        </div>
    </div>

    <script>
        // Global function to show the main catalog view.
        // This is in the global scope so the onclick attribute in HTML can find it.
        function showCatalog() {
            // Update the URL to the base path
            history.pushState(null, '', window.location.pathname);
            
            const catalogView = document.getElementById('catalog_view');
            const setDetailView = document.getElementById('set_detail_view');
            const themeSelect = document.getElementById('theme-select');
            
            // Set the current set ID to null since we're back on the catalog page.
            currentSetId = null; 
            
            // Hide the set detail view and show the catalog view.
            setDetailView.classList.add('hidden');
            catalogView.classList.remove('hidden');

            // Reset the theme and search fields to clear any previous filters.
            themeSelect.value = "";
            searchInput.value = "";

            // Reload the sets to show all sets.
            loadSets("", "");
        }
        
        // Function to update the URL with a set ID without reloading the page.
        function updateUrlAndHistory(setId) {
            const newUrl = setId ? `${window.location.pathname}?set=${setId}` : window.location.pathname;
            history.pushState({ setId: setId }, '', newUrl);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const catalogView = document.getElementById('catalog_view');
            const setDetailView = document.getElementById('set_detail_view');
            const setsCatalog = document.getElementById('sets_catalog');
            const setDetailContent = document.getElementById('set_detail_content');
            const backButton = document.getElementById('back_to_catalog');
            const themeSelect = document.getElementById('theme-select');
            const searchInput = document.getElementById('search_input');
            const loader = document.getElementById('loader');
            const languageSelect = document.getElementById('language-select');
            const flagIcon = document.getElementById('flag-icon');

            let allData = {};
            let currentSets = [];
            let currentSetId = null;
            let currentImages = []; 
            let currentImageIndex = 0; 
            
            // Global variables for the video gallery
            let currentVideos = [];
            let currentVideoIndex = 0;

            const translations = {
                en: {
                    store_title: "Visit My BrickLink Store!",
                    store_text: "Find new and used LEGO sets, parts, and minifigures in my store. I offer a wide selection and great prices.",
                    store_button: "Go to the Store",
                    catalog_title: "My LEGO Sets Catalog",
                    catalog_subtitle: "A showcase of my favorite LEGO sets.",
                    theme_label: "Select a Theme:",
                    search_placeholder: "Search sets...",
                    all_themes: "All Themes",
                    loading_themes: "Loading themes...",
                    back_button: "← Back to Catalog",
                    connect_title: "Connect With Me",
                    no_sets_found: "No sets found for this theme or search term.",
                    about_this_set: "About This Set",
                    my_review_videos: "My Review Videos",
                    preview_text_snippet: "...",
                    pieces: "Pieces",
                    minifigures: "Minifigures",
                    year_released: "Year Released",
                    age: "Age",
                    no_videos_found: "No videos available for this set."
                },
                ua: {
                    store_title: "Відвідайте мій магазин на BrickLink!",
                    store_text: "Знайдіть нові та вживані набори LEGO, деталі та мініфігурки в моєму магазині. Я пропоную широкий вибір і чудові ціни.",
                    store_button: "Перейти до магазину",
                    catalog_title: "Мій каталог наборів LEGO",
                    catalog_subtitle: "Демонстрація моїх улюблених наборів LEGO.",
                    theme_label: "Виберіть тему:",
                    search_placeholder: "Пошук наборів...",
                    all_themes: "Усі теми",
                    loading_themes: "Завантаження тем...",
                    back_button: "← Назад до каталогу",
                    connect_title: "Зв'язатися зі мною",
                    no_sets_found: "Наборів для цієї теми або пошукового запиту не знайдено.",
                    about_this_set: "Про цей набір",
                    my_review_videos: "Мої відеоогляди",
                    preview_text_snippet: "...",
                    pieces: "Деталі",
                    minifigures: "Мініфігурки",
                    year_released: "Рік випуску",
                    age: "Вік",
                    no_videos_found: "Відео для цього набору немає."
                }
            };
            
            // Map language codes to flag URLs
            const flagMap = {
                en: "./images/us.svg",
                ua: "./images/ua.svg"
            };

            // Function to apply translations for static elements and re-render dynamic content
            const setLanguage = (lang) => {
                const translation = translations[lang];
                document.querySelectorAll('[data-translate]').forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (translation[key]) {
                        element.textContent = translation[key];
                    }
                });
                searchInput.placeholder = translation.search_placeholder;
                document.querySelector('#sets_catalog').setAttribute('data-no-sets-message', translation.no_sets_found);
                
                // Update the flag icon
                flagIcon.src = flagMap[lang];

                // Re-render the sets catalog cards to show the correct language
                loadSets(themeSelect.value, searchInput.value);

                // If a set detail page is currently open, re-render it with the new language
                if (!setDetailView.classList.contains('hidden') && currentSetId) {
                    renderSetDetail(currentSetId);
                }
            };

            // This array holds the filenames for each theme's data.
            const themeFiles = [
                "one_piece.json" //, ""
            ];

            // This function fetches data from all theme-specific JSON files.
            const fetchAllData = async () => {
                loader.classList.remove('hidden');
                const fetchPromises = themeFiles.map(fileName => 
                    fetch(`./data/${fileName}`).then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load ${fileName}: ${response.statusText}`);
                        }
                        return response.json();
                    }).catch(error => {
                        console.error(error);
                        // Return an empty object for a failed fetch to prevent the app from crashing.
                        return {};
                    })
                );

                const results = await Promise.all(fetchPromises);
                
                // Merge all the data from the fetched files into a single object.
                let mergedData = {};
                results.forEach(data => {
                    Object.assign(mergedData, data);
                });
                loader.classList.add('hidden');
                return mergedData;
            };

            const loadThemes = () => {
                const themes = Object.keys(allData);
                const currentLang = languageSelect.value || 'en';
                const allThemesText = translations[currentLang].all_themes;
                
                themeSelect.innerHTML = `<option value="">${allThemesText}</option>`;
                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme;
                    option.textContent = theme;
                    themeSelect.appendChild(option);
                });
            };

            const renderSetsCatalog = (sets) => {
                setsCatalog.innerHTML = '';
                const currentLang = languageSelect.value || 'en';
                
                if (sets.length === 0) {
                    setsCatalog.innerHTML = `<p class="text-center text-gray-500 col-span-full">${setsCatalog.getAttribute('data-no-sets-message')}</p>`;
                    return;
                }

                sets.forEach(set => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.setAttribute('data-id', set.id);
                    card.innerHTML = `
                        <img src="${set.images[0]}" alt="${set.name[currentLang]}" class="w-full h-48 object-cover rounded-lg mb-4">
                        <h3 class="text-lg font-bold">${set.name[currentLang]}</h3>
                        <p class="text-sm text-gray-600">${set.description[currentLang].substring(0, 100)}${set.description[currentLang].length > 100 ? '...' : ''}</p>
                    `;
                    card.addEventListener('click', () => showSetDetail(set.id));
                    setsCatalog.appendChild(card);
                });
            };
            
            const loadSets = (themeId, searchTerm = '') => {
                let setsToDisplay = [];
                if (themeId) {
                    setsToDisplay = allData[themeId] || [];
                } else {
                    for (const theme in allData) {
                        setsToDisplay = setsToDisplay.concat(allData[theme]);
                    }
                }
                
                const currentLang = languageSelect.value || 'en';
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                const filteredSets = setsToDisplay.filter(set =>
                    (set.name?.[currentLang] || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (set.description?.[currentLang] || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (set.id || '').toLowerCase().includes(lowerCaseSearchTerm)
                );

                currentSets = filteredSets;
                renderSetsCatalog(currentSets);
            };

            // This function updates the main image and highlights the active thumbnail.
            const updateMainImage = () => {
                const mainImage = document.getElementById('main-set-image');
                const thumbnails = document.querySelectorAll('.thumbnail');
                if (mainImage && thumbnails.length > 0) {
                    // Update main image source
                    mainImage.src = currentImages[currentImageIndex];

                    // Update active thumbnail class
                    thumbnails.forEach((t, index) => {
                        t.classList.toggle('active', index === currentImageIndex);
                    });
                }
            };
            
            // This function renders the detailed view of a specific set.
            const renderSetDetail = (setId) => {
                const set = allData[themeSelect.value]?.find(s => s.id === setId) || Object.values(allData).flat().find(s => s.id === setId);
                if (set) {
                    const currentLang = languageSelect.value || 'en';
                    const t = translations[currentLang];
                    
                    currentImages = set.images || [];
                    currentImageIndex = 0;
                    currentVideos = set.videos || [];

                    const thumbnailsHtml = currentImages.map((imageSrc, index) => 
                        `<img src="${imageSrc}" alt="Thumbnail ${index + 1}" class="thumbnail w-24 h-24 object-contain rounded-md cursor-pointer ${index === 0 ? 'active' : ''}" data-image-index="${index}">`
                    ).join('');

                    // Simplified HTML for the video gallery
                    const videoGalleryHtml = set.videos && set.videos.length > 0 ? `
                        <div class="relative w-full" style="padding-bottom: 56.25%;">
                            <iframe
                                id="video-player"
                                class="absolute top-0 left-0 w-full h-full rounded-lg shadow-lg"
                                src="${set.videos[0].link}"
                                title="Video Player"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                                frameborder="0"
                            ></iframe>
                        </div>
                    ` : `<p class="text-sm text-center text-gray-500">${t.no_videos_found}</p>`;

                    setDetailContent.innerHTML = `
                        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-yellow-400 pb-2">${set.name[currentLang]} (${set.id})</h1>
                        
                        <div class="my-4">
                            <div class="main-image-container mb-4">
                                <img id="main-set-image" src="${currentImages[0]}" alt="LEGO Set ${set.id}" class="w-full h-full rounded-lg shadow-lg">
                                <button id="prev-image" class="nav-arrow left">&lt;</button>
                                <button id="next-image" class="nav-arrow right">&gt;</button>
                            </div>
                            <div id="thumbnail-gallery" class="flex space-x-2 overflow-x-auto mt-2">
                                ${thumbnailsHtml}
                            </div>
                        </div>

                        <!-- Set specifications in a single row -->
                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-wrap justify-around items-center gap-4 text-center">
                            ${set.pieces ? `<div class="flex-1 min-w-[150px]">
                                <p class="text-sm font-semibold">${t.pieces}</p>
                                <p class="text-xl font-bold">${set.pieces}</p>
                            </div>` : ''}
                            ${set.minifigs ? `<div class="flex-1 min-w-[150px]">
                                <p class="text-sm font-semibold">${t.minifigures}</p>
                                <p class="text-xl font-bold">${set.minifigs}</p>
                            </div>` : ''}
                            ${set.year ? `<div class="flex-1 min-w-[150px]">
                                <p class="text-sm font-semibold">${t.year_released}</p>
                                <p class="text-xl font-bold">${set.year}</p>
                            </div>` : ''}
                            ${set.age ? `<div class="flex-1 min-w-[150px]">
                                <p class="text-sm font-semibold">${t.age}</p>
                                <p class="text-xl font-bold">${set.age}</p>
                            </div>` : ''}
                        </div>
                        
                        <!-- The "About This Set" section is now after the new specification row -->
                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${t.about_this_set}</h3>
                            <p class="text-gray-700">${set.description[currentLang]}</p>
                        </div>
                        
                        <div class="mt-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-yellow-400 pb-2">${t.my_review_videos}</h3>
                            ${videoGalleryHtml}
                        </div>
                    `;

                    // Add event listeners for the new navigation buttons and thumbnails
                    document.getElementById('prev-image').addEventListener('click', () => {
                        currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
                        updateMainImage();
                    });
                    document.getElementById('next-image').addEventListener('click', () => {
                        currentImageIndex = (currentImageIndex + 1) % currentImages.length;
                        updateMainImage();
                    });

                    document.querySelectorAll('.thumbnail').forEach(thumbnail => {
                        thumbnail.addEventListener('click', (event) => {
                            const index = parseInt(event.target.getAttribute('data-image-index'), 10);
                            currentImageIndex = index;
                            updateMainImage();
                        });
                    });
                }
            };

            const showSetDetail = (setId) => {
                currentSetId = setId;
                renderSetDetail(setId);
                catalogView.classList.add('hidden');
                setDetailView.classList.remove('hidden');
                // Use the new function to add an entry to the browser's history
                updateUrlAndHistory(setId);
            };

            // Event listener for the browser's back and forward buttons
            window.addEventListener('popstate', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const setId = urlParams.get('set');
                if (setId) {
                    // Show the detail view for the set from the URL
                    showSetDetail(setId);
                    // This prevents the URL from getting messy
                    history.replaceState({ setId: setId }, '', window.location.pathname + window.location.search);
                } else {
                    // Show the catalog view if no set ID is in the URL
                    showCatalog();
                }
            });

            backButton.addEventListener('click', showCatalog);
            
            themeSelect.addEventListener('change', (event) => {
                const selectedTheme = event.target.value;
                loadSets(selectedTheme, searchInput.value);
            });

            searchInput.addEventListener('input', (event) => {
                const searchTerm = event.target.value;
                loadSets(themeSelect.value, searchTerm);
            });

            // New event listener for the language dropdown
            languageSelect.addEventListener('change', (event) => {
                const selectedLang = event.target.value;
                setLanguage(selectedLang);
                loadThemes(); // Reload themes to show in new language
            });

            allData = await fetchAllData();
            loadThemes();
            
            // Check for a set ID in the URL on initial page load
            const urlParams = new URLSearchParams(window.location.search);
            const initialSetId = urlParams.get('set');
            if (initialSetId) {
                showSetDetail(initialSetId);
            } else {
                loadSets("");
                setLanguage('en');
            }
        });
    </script>
</body>
</html>
